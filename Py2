import discord
from discord.ext import commands
import requests
from flask import Flask
from threading import Thread

# ---------- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Discord Bot Token ----------
TOKEN = "‡πÉ‡∏™‡πà Discord Bot Token ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"

# ---------- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ intents ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ----------
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö keep_alive ----------
app = Flask('')

@app.route('/')
def home():
    return "I'm alive!"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

# ---------- ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á !f ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô Roblox ----------
@bot.command()
async def f(ctx, username: str):
    # 1. ‡∏î‡∏∂‡∏á User ID ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
    url_username = f"https://api.roblox.com/users/get-by-username?username={username}"
    res_user = requests.get(url_username)
    if res_user.status_code != 200:
        await ctx.send("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API Roblox")
        return
    data_user = res_user.json()
    if "Id" not in data_user or data_user["Id"] == 0:
        await ctx.send(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô `{username}` ‡πÉ‡∏ô Roblox")
        return

    user_id = data_user["Id"]

    # 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    url_info = f"https://users.roblox.com/v1/users/{user_id}"
    res_info = requests.get(url_info)
    if res_info.status_code != 200:
        await ctx.send("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ")
        return
    data_info = res_info.json()

    display_name = data_info.get("displayName", username)
    created = data_info.get("created", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")
    created = created.split("T")[0] if created != "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" else created

    # 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (presence)
    url_presence = "https://presence.roblox.com/v1/presence/users"
    res_presence = requests.post(url_presence, json={"userIds": [user_id]})
    online_status = "‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå"
    if res_presence.status_code == 200:
        data_presence = res_presence.json()
        if data_presence and "userPresences" in data_presence and data_presence["userPresences"]:
            user_presence = data_presence["userPresences"][0]
            if user_presence.get("userPresenceType") == 1:
                online_status = "‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå"
            elif user_presence.get("lastLocation"):
                online_status = f"üïí ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà: {user_presence.get('lastLocation')}"
    else:
        online_status = "‚ùì ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ"

    profile_url = f"https://www.roblox.com/users/{user_id}/profile"
    avatar_url = f"https://www.roblox.com/headshot-thumbnail/image?userId={user_id}&width=420&height=420&format=png"

    embed = discord.Embed(title=f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô Roblox: {display_name}", url=profile_url, color=0xFF0000)
    embed.set_thumbnail(url=avatar_url)
    embed.add_field(name="User ID", value=str(user_id), inline=True)
    embed.add_field(name="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (DisplayName)", value=display_name, inline=True)
    embed.add_field(name="‡∏ß‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", value=created, inline=False)
    embed.add_field(name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå", value=online_status, inline=False)
    embed.add_field(name="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå", value=f"[‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà]({profile_url})", inline=False)

    await ctx.send(embed=embed)

# ---------- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å keep_alive ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡∏ö‡∏≠‡∏ó ----------
keep_alive()
bot.run(TOKEN)
